package vakiliner.chatcomponentapi.component;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Queue;
import java.util.Set;
import java.util.function.Supplier;
import vakiliner.chatcomponentapi.common.ChatNamedColor;
import vakiliner.chatcomponentapi.common.ChatTextColor;
import vakiliner.chatcomponentapi.common.ChatTextFormat;

public abstract class ChatComponent {
	protected ChatStyle style;
	protected List<ChatComponent> extra;

	public ChatComponent() {
		this(ChatStyle.EMPTY);
	}

	public ChatComponent(ChatTextColor color) {
		this(ChatStyle.EMPTY.withColor(color));
	}

	public ChatComponent(ChatStyle style) {
		this.style = Objects.requireNonNull(style);
	}

	protected ChatComponent(ChatComponent component, boolean cloneExtra) {
		this.style = component.style;
		if (cloneExtra) {
			List<ChatComponent> clone = component.extra;
			if (clone != null) {
				List<ChatComponent> extra = this.extra = new ArrayList<>();
				clone.forEach((c) -> extra.add(c.clone(true)));
			}
		} else {
			this.extra = component.extra;
		}
	}

	public ChatComponent clone() {
		return this.clone(true);
	}

	public abstract ChatComponent clone(boolean cloneExtra);

	public String toLegacyText() {
		return this.toLegacyText(ChatNamedColor.RESET, Collections.emptySet());
	}

	protected String toLegacyText(final ChatTextColor parentColor, final Set<ChatComponentFormat> parentFormats) {
		StringBuilder text = new StringBuilder();
		Set<ChatComponentFormat> formats = new HashSet<>(parentFormats);
		ChatTextColor color = this.getColorRaw();
		if (color == null) color = parentColor;
		boolean reset = !color.equals(parentColor);
		for (Map.Entry<ChatComponentFormat, Boolean> entry : this.getFormatsRaw().entrySet()) {
			Boolean isSet = entry.getValue();
			if (isSet != null) {
				if (isSet) {
					formats.add(entry.getKey());
				} else if (formats.remove(entry.getKey())) {
					reset = true;
				}
			}
		}
		formats = Collections.unmodifiableSet(formats);
		if (reset) {
			ChatTextFormat textFormat = color.asFormat();
			if (textFormat == null) textFormat = ChatTextFormat.RESET;
			text.append(textFormat);
			for (ChatComponentFormat format : formats) {
				text.append(format.asTextFormat());
			}
		} else for (ChatComponentFormat format : formats) {
			if (!parentFormats.contains(format)) {
				text.append(format.asTextFormat());
			}
		}
		text.append(this.getLegacyText(color, formats));
		List<ChatComponent> extra = this.getExtra();
		if (extra != null) for (ChatComponent component : extra) {
			text.append(component.toLegacyText(color, formats));
		}
		if (!(reset = !color.equals(parentColor))) for (ChatComponentFormat format : formats) {
			if (!parentFormats.contains(format)) {
				reset = true;
				break;
			}
		}
		if (reset) {
			text.append(parentColor.asFormat());
			for (ChatComponentFormat format : parentFormats) {
				text.append(format);
			}
		} else for (ChatComponentFormat format : parentFormats) {
			if (!formats.contains(format)) {
				text.append(format);
			}
		}
		return text.toString();
	}

	protected abstract String getLegacyText(ChatTextColor parentColor, Set<ChatComponentFormat> parentFormats);

	public ChatStyle getStyle() {
		return this.style;
	}

	@Deprecated
	public ChatTextColor getColorRaw() {
		return this.style.getColor();
	}

	@Deprecated
	public Boolean isBoldRaw() {
		return this.style.getBold();
	}

	@Deprecated
	public Boolean isItalicRaw() {
		return this.style.getItalic();
	}

	@Deprecated
	public Boolean isUnderlinedRaw() {
		return this.style.getUnderlined();
	}

	@Deprecated
	public Boolean isStrikethroughRaw() {
		return this.style.getStrikethrough();
	}

	@Deprecated
	public Boolean isObfuscatedRaw() {
		return this.style.getObfuscated();
	}

	@Deprecated
	public String getInsertion() {
		return this.style.getInsertion();
	}

	@Deprecated
	public ChatClickEvent getClickEvent() {
		return this.style.getClickEvent();
	}

	@Deprecated
	public ChatHoverEvent<?> getHoverEvent() {
		return this.style.getHoverEvent();
	}

	public List<ChatComponent> getExtra() {
		List<ChatComponent> extra = this.extra;
		return extra != null ? Collections.unmodifiableList(extra) : null;
	}

	@Deprecated
	public Boolean getFormatRaw(ChatComponentFormat format) {
		return this.style.getFormat(format);
	}

	public Map<ChatComponentFormat, Boolean> getFormatsRaw() {
		return this.style.getFormats();
	}

	public void setStyle(ChatStyle style) {
		this.style = Objects.requireNonNull(style);
	}

	@Deprecated
	public void setColor(ChatTextColor color) {
		this.setStyle(this.style.withColor(color));
	}

	@Deprecated
	public void setBold(Boolean bold) {
		this.setStyle(this.style.withBold(bold));
	}

	@Deprecated
	public void setItalic(Boolean italic) {
		this.setStyle(this.style.withItalic(italic));
	}

	@Deprecated
	public void setUnderlined(Boolean underlined) {
		this.setStyle(this.style.withUnderlined(underlined));
	}

	@Deprecated
	public void setStrikethrough(Boolean strikethrough) {
		this.setStyle(this.style.withStrikethrough(strikethrough));
	}

	@Deprecated
	public void setObfuscated(Boolean obfuscated) {
		this.setStyle(this.style.withObfuscated(obfuscated));
	}

	@Deprecated
	public void setInsertion(String insertion) {
		this.setStyle(this.style.withInsertion(insertion));
	}

	@Deprecated
	public void setClickEvent(ChatClickEvent clickEvent) {
		this.setStyle(this.style.withClickEvent(clickEvent));
	}

	@Deprecated
	public void setHoverEvent(ChatHoverEvent<?> hoverEvent) {
		this.setStyle(this.style.withHoverEvent(hoverEvent));
	}

	public void setExtra(Collection<ChatComponent> children) {
		if (children == null) {
			this.extra = null;
		} else {
			this.extra = new ArrayList<>(children);
		}
	}

	@Deprecated
	public void setFormat(ChatComponentFormat format, Boolean isSet) {
		this.setStyle(this.style.withFormat(format, isSet));
	}

	@Deprecated
	public void setFormats(Map<ChatComponentFormat, Boolean> map) {
		this.setStyle(this.style.withFormats(map));
	}

	protected void unsafeAppend(ChatComponent component) {
		List<ChatComponent> extra = this.extra;
		if (extra == null) synchronized (this) {
			if ((extra = this.extra) == null) {
				extra = this.extra = new ArrayList<>();
			}
		}
		extra.add(component);
	}

	public void append(ChatComponent component) {
		if (component == this) throw new IllegalArgumentException("This component cannot be added");
		List<ChatComponent> extra = component.extra;
		if (extra != null) {
			Set<ChatComponent> set = new HashSet<>();
			Queue<ChatComponent> queue = new LinkedList<>(extra);
			ChatComponent check = null;
			while ((check = queue.poll()) != null) {
				if (set.contains(check)) continue;
				if (check == this) throw new IllegalArgumentException("Components are looping, try cloning the component before appending");
				List<ChatComponent> e = check.extra;
				if (e != null) queue.addAll(e);
				set.add(check);
			}
		}
		this.unsafeAppend(component);
	}

	public ChatComponentWithLegacyText withLegacyComponent(Supplier<ChatComponent> getLegacyComponent) {
		return new ChatComponentWithLegacyText(this, getLegacyComponent);
	}

	public ChatComponentWithLegacyText withLegacyComponent(ChatComponent legacyComponent) {
		return new ChatComponentWithLegacyText(this, legacyComponent);
	}

	public ChatComponentWithLegacyText withLegacyText(Supplier<String> getLegacyText) {
		return this.withLegacyComponent(() -> new ChatTextComponent(getLegacyText.get()));
	}

	public ChatComponentWithLegacyText withLegacyText(String legacyText) {
		return new ChatComponentWithLegacyText(this, new ChatTextComponent(legacyText));
	}

	public boolean equals(Object obj) {
		if (this == obj) {
			return true;
		} else if (!(obj instanceof ChatComponent)) {
			return false;
		} else {
			ChatComponent other = (ChatComponent) obj;
			return this.style.equals(other.style) && (this.extra == other.extra || (this.extra == null || this.extra.isEmpty() ? other.extra == null || other.extra.isEmpty() : this.extra.equals(other.extra)));
		}
	}
}